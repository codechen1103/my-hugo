name: åŒæ­¥ Obsidian æ–‡ç« 

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # å½“ Obsidian ä»“åº“æ›´æ–°æ—¶è§¦å‘
  repository_dispatch:
    types: [obsidian_updated]
  # å®šæ—¶è§¦å‘ï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹ï¼‰
  schedule:
    - cron: '0 18 * * *'  # UTC 18:00 = åŒ—äº¬æ—¶é—´ 02:00
  # å½“æœ‰æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘ï¼ˆå¯é€‰ï¼‰
  push:
    branches:
      - main
    paths:
      - '.github/workflows/sync-obsidian.yml'

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºåšå®¢ä»“åº“
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.OBSIDIAN_TOKEN }}
          fetch-depth: 0
          submodules: true
      
      - name: æ£€å‡º Obsidian ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.OBSIDIAN_REPO }}  # æ ¼å¼: username/repo-name
          token: ${{ secrets.OBSIDIAN_TOKEN }}
          path: obsidian-vault
          fetch-depth: 1
      
      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: å®‰è£… Python ä¾èµ–
        run: |
          pip install pyyaml
      
      - name: åŒæ­¥æ–‡ç« 
        run: |
          python .github/scripts/sync-posts.py
      
      - name: è®¾ç½® Hugo ç¯å¢ƒ
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true
      
      - name: æ„å»º Hugo ç«™ç‚¹
        run: hugo --minify
      
      - name: æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        id: check_changes
        run: |
          git add content/posts/
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ç« æ›´æ”¹"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… æ£€æµ‹åˆ°æ–‡ç« æ›´æ”¹"
          fi
      
      - name: æäº¤æ›´æ”¹
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add content/posts/ public/
          git commit -m "ğŸ”„ è‡ªåŠ¨åŒæ­¥ Obsidian æ–‡ç« å¹¶æ„å»ºç«™ç‚¹ [$(date +'%Y-%m-%d %H:%M:%S')]"
          git push
      
      - name: åŒæ­¥å®Œæˆé€šçŸ¥
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "âœ… æ–‡ç« åŒæ­¥å®Œæˆï¼"
          echo "ğŸ“ å·²åŒæ­¥çš„æ–‡ç« æ•°é‡: $(git diff HEAD~1 --name-only content/posts/ | wc -l)"